from flask import Flask, redirect, render_template, request
import subprocess
from libnmap.parser import NmapParser

# Configure application
app = Flask(__name__)

@app.route('/')
def index():
    #command = "nmap -sP 172.31.151.90/26;"
    #my_output = subprocess.check_output(command, shell=True).decode('utf-8')
    return render_template("index.html")  

@app.route('/scan', methods=["GET","POST"])
def scan():
    if request.method=='POST':
        ip=request.form.get('ip_range')
        command='nmap -sP '+ip+' ;'
        myoutput=subprocess.check_output(command, shell=True).decode('utf-8')
        return render_template("result.html", my_output=myoutput)

    return render_template("scan.html")

@app.route('/scanresult', methods=["GET","POST"])
def scanresult():

    #complete scan report
    nmap_report = NmapParser.parse_fromfile('/Users/achalsaharan/capstone/intense-ping.xml')

    #unique products found in the scan
    products=sorted(set([ b.banner for a in nmap_report.hosts for b in a.services if 'product' in b.banner]))

    #unique ports found open on all the hosts combines
    ports=sorted(set([ b[0] for a in nmap_report.hosts for b in a.get_open_ports()]), key=int)

    #finding one active host to display initial data
    for h in nmap_report.hosts:
        if h.is_up():
            break

    #distinct devices types
    devices= set() #intilazing an empty set
    for h in nmap_report.hosts:
        if len(h.os_class_probabilities())>0:
            devices.add(h.os_class_probabilities()[0].description)  
        
    h=nmap_report.get_host_byid('172.31.151.167') 

    #default port info to diplay
    port=ports[0]

    #to display host data when the user selects an ip or a port
    if request.method == 'POST':
        if "port_submit" in request.form:
            port=int(request.form.get('port_submit'))
        elif "ip_submit" in request.form:    
            ip=request.form.get('ip_submit')
            h=nmap_report.get_host_byid(ip)

    ips_with_port=[ a.address for a in nmap_report.hosts if (a.get_open_ports()) and port in [b[0] for b in a.get_open_ports()] ]


    return render_template("result.html",report=nmap_report, products=products, ports=ports,host=h,devices=devices,port=port,
    ips_with_port=ips_with_port)

if __name__=='__main__':
    app.run(debug=True)