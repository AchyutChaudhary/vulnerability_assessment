from flask import Flask, redirect, render_template, request 
from flask import Blueprint

scan_route = Blueprint('scan_route', __name__)

@scan_route.route('/scan', methods=["GET","POST"])
def scan():
    if request.method=='POST':

        #getting all data from the form
        ip = request.form.get('ip_range') # improve this to filter user input
        filename = request.form.get('scan_name')
        comments = request.form.get('comments')
        scan_type = request.form.get('scan_type')

        # nmap -oX /Users/achalsaharan/Desktop/tmp.xml -T4 -A -v 172.31.151.90/24   || how a typical command looks

        # commands dictionary to craft command
        commands={
            "intense scan": "-T4 -A -v",
            "ping scan": "-sn",
            "quick scan": "-T4 -F",
            "intense scan, no ping": "-T4 -A -v -Pn",
            "regular scan": "",
            "intense scan plus UDP": "-sS -sU -T4 -A -v 172.31.151.90/24",
            "intense scan, all TCP ports": "-p 1-65535 -T4 -A -v"
        }

        

        #crafting command
        command = "nmap -oX /Users/achalsaharan/capweb/scans/"+filename+".xml"+" "+ commands[scan_type]+" "+ip
        print(command)

        #running command using subprocess
        myoutput=subprocess.check_output(command, shell=True).decode('utf-8')


        #return render_template("result.html", my_output=myoutput)

    return render_template("scan.html",title='Scan')